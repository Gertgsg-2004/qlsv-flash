{% extends "base.html" %}
{% set title="Quản lý sinh viên" %}
{% block content %}

<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <b>Danh sách sinh viên</b>
    <a class="btn btn-success btn-sm"
       href="{{ url_for('admin.admin_students_create') }}">
      + Thêm sinh viên
    </a>
  </div>

  <div class="card-body">

    <!-- Search -->
    <form class="row g-2 mb-3" method="GET">
      <div class="col-md-3">
        <input class="form-control" name="ma_sv"
               placeholder="Mã SV" value="{{ ma_sv }}">
      </div>
      <div class="col-md-4">
        <input class="form-control" name="ten_sv"
               placeholder="Tên SV" value="{{ ten_sv }}">
      </div>
      <div class="col-md-2">
        <select class="form-select" name="per_page">
          <option value="5"  {% if per_page==5 %}selected{% endif %}>5</option>
          <option value="10" {% if per_page==10 %}selected{% endif %}>10</option>
          <option value="20" {% if per_page==20 %}selected{% endif %}>20</option>
        </select>
      </div>
      <div class="col-md-3 d-flex gap-2">
        <button class="btn btn-primary">Lọc</button>
        <a class="btn btn-secondary"
           href="{{ url_for('admin.admin_students_index') }}">
          Reset
        </a>
      </div>
    </form>

    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Avatar</th>
            <th>Mã SV</th>
            <th>Tên</th>
            <th>Email</th>
            <th>Giới tính</th>
            <th>Địa chỉ</th>
            <th width="160">Hành động</th>
          </tr>
        </thead>

        <tbody>
          {% for s in students %}
          <tr>
            <td>{{ s.id }}</td>

            <td>
              <div class="d-flex align-items-center gap-2">
                {% if s.avatar %}
                  <img src="{{ url_for('static', filename='uploads/' ~ s.avatar) }}"
                       width="40" height="40"
                       style="border-radius:50%;object-fit:cover;">
                {% else %}
                  <div style="width:40px;height:40px;border-radius:50%;background:#ccc"></div>
                {% endif %}

                <form method="POST"
                      action="{{ url_for('admin.admin_student_upload_avatar', student_id=s.id) }}"
                      enctype="multipart/form-data"
                      class="d-flex gap-1">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <input type="file" name="avatar"
                         class="form-control form-control-sm"
                         accept=".png,.jpg,.jpeg,.webp" required>
                  <button class="btn btn-sm btn-warning">Up</button>
                </form>
              </div>
            </td>

            <td>{{ s.ma_sv }}</td>
            <td>{{ s.ten_sv }}</td>
            <td>{{ s.email }}</td>
            <td>{{ s.gioi_tinh or "" }}</td>
            <td>{{ s.dia_chi or "" }}</td>

            <td>
              <a class="btn btn-sm btn-secondary"
                 href="{{ url_for('admin.admin_students_edit', student_id=s.id) }}">
                Sửa
              </a>

              <form method="POST"
                    action="{{ url_for('admin.admin_students_delete', student_id=s.id) }}"
                    style="display:inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-danger"
                        onclick="return confirm('Xóa sinh viên?')">
                  Xóa
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}

          {% if students|length == 0 %}
          <tr>
            <td colspan="8" class="text-center text-muted">
              Không có dữ liệu
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <ul class="pagination">
      {% if pagination.has_prev %}
      <li class="page-item">
        <a class="page-link"
           href="{{ url_for('admin.admin_students_index', page=pagination.prev_num) }}">
          Prev
        </a>
      </li>
      {% endif %}

      {% for p in pagination.iter_pages() %}
        {% if p %}
        <li class="page-item {% if p==pagination.page %}active{% endif %}">
          <a class="page-link"
             href="{{ url_for('admin.admin_students_index', page=p) }}">{{ p }}</a>
        </li>
        {% endif %}
      {% endfor %}

      {% if pagination.has_next %}
      <li class="page-item">
        <a class="page-link"
           href="{{ url_for('admin.admin_students_index', page=pagination.next_num) }}">
          Next
        </a>
      </li>
      {% endif %}
    </ul>

  </div>
</div>

{% endblock %}
