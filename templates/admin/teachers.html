{% extends "base.html" %}
{% set title="Qu·∫£n l√Ω gi√°o vi√™n & G√°n l·ªõp" %}
{% block content %}

<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
    <b>Qu·∫£n l√Ω gi√°o vi√™n & G√°n l·ªõp</b>

    <div class="d-flex gap-2 flex-wrap">
      <!-- Th√™m gi√°o vi√™n: d√πng form t·∫°o student/user r·ªìi set role=manager (b·∫°n c√≥ th·ªÉ ch·ªânh l·∫°i route n·∫øu mu·ªën) -->
      <a class="btn btn-success btn-sm" href="{{ url_for('admin.admin_students_create') }}">
        + Th√™m gi√°o vi√™n
      </a>

      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('admin.admin_home') }}">
        ‚¨Ö V·ªÅ Dashboard
      </a>

      <a class="btn btn-outline-primary btn-sm" href="{{ url_for('admin.admin_users') }}">
        üë§ Users & Ph√¢n quy·ªÅn
      </a>
    </div>
  </div>

  <div class="card-body">

    {% if teachers|length == 0 %}
      <div class="alert alert-warning mb-0">
        Ch∆∞a c√≥ gi√°o vi√™n (role = manager). H√£y t·∫°o user v√† set role = manager tr∆∞·ªõc.
      </div>
    {% else %}

    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-dark">
          <tr>
            <th style="width:70px;">ID</th>
            <th style="width:260px;">Gi√°o vi√™n</th>
            <th style="width:220px;">T√™n</th>
            <th>Email</th>
            <th style="width:120px;">Gi·ªõi t√≠nh</th>
            <th style="width:220px;">ƒê·ªãa ch·ªâ</th>
            <th style="width:420px;">G·∫Øn l·ªõp</th>
            <th style="width:210px;">H√†nh ƒë·ªông</th>
          </tr>
        </thead>

        <tbody>
          {% for t in teachers %}
          <tr>
            <td>{{ t.id }}</td>

            <!-- Avatar + Role -->
            <td>
              <div class="d-flex align-items-center gap-2">
                {% if t.avatar %}
                  <img src="{{ url_for('static', filename='uploads/' ~ t.avatar) }}"
                       width="44" height="44"
                       style="border-radius:50%;object-fit:cover;"
                       alt="avatar">
                {% else %}
                  <div style="width:44px;height:44px;border-radius:50%;background:#ccc;"></div>
                {% endif %}

                <div>
                  <div class="fw-bold">{{ (t.ten_sv or "Gi√°o vi√™n") }}</div>
                  <small class="text-muted">Role: {{ t.role }}</small>
                </div>
              </div>
            </td>

            <td>{{ t.ten_sv or "" }}</td>
            <td>{{ t.email }}</td>
            <td>{{ t.gioi_tinh or "" }}</td>
            <td>{{ t.dia_chi or "" }}</td>

            <!-- ‚úÖ G·∫Øn l·ªõp + CSRF + checked -->
            <td>
              <form method="POST"
                    action="{{ url_for('admin.admin_teacher_update_classes', teacher_id=t.id) }}"
                    class="d-flex flex-wrap gap-2 align-items-center">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                {% set selected_ids = (t.teaching_classes | map(attribute='id') | list) if t.teaching_classes else [] %}

                {% for c in classes %}
                  <div class="form-check me-2">
                    <input class="form-check-input"
                           type="checkbox"
                           name="class_ids"
                           value="{{ c.id }}"
                           id="t{{ t.id }}_c{{ c.id }}"
                           {% if c.id in selected_ids %}checked{% endif %}>
                    <label class="form-check-label" for="t{{ t.id }}_c{{ c.id }}">
                      {{ c.code }} - {{ c.name }}
                    </label>
                  </div>
                {% endfor %}
              </form>

              <small class="text-muted d-block mt-1">
                Tick l·ªõp ‚Üí b·∫•m <b>L∆∞u l·ªõp</b> ƒë·ªÉ c·∫≠p nh·∫≠t.
              </small>
            </td>

            <!-- ‚úÖ H√†nh ƒë·ªông: L∆∞u l·ªõp / S·ª≠a / X√≥a -->
            <td class="text-nowrap">

              <!-- L∆∞u l·ªõp: submit form ·ªü c·ªôt G·∫Øn l·ªõp -->
              <button class="btn btn-sm btn-primary mb-1"
                      onclick="this.closest('tr').querySelector('form').submit();">
                L∆∞u l·ªõp
              </button>

              <!-- S·ª≠a gi√°o vi√™n: d√πng route edit student/user (b·∫°n ƒë·ªïi endpoint n·∫øu kh√°c) -->
              <a class="btn btn-sm btn-secondary mb-1"
                 href="{{ url_for('admin.admin_students_edit', student_id=t.id) }}">
                S·ª≠a
              </a>

              <!-- X√≥a gi√°o vi√™n: d√πng route delete student/user (b·∫°n ƒë·ªïi endpoint n·∫øu kh√°c) -->
              <form method="POST"
                    action="{{ url_for('admin.admin_students_delete', student_id=t.id) }}"
                    style="display:inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-danger mb-1"
                        onclick="return confirm('X√≥a gi√°o vi√™n n√†y?')">
                  X√≥a
                </button>
              </form>

            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% endif %}
  </div>
</div>

{% endblock %}
